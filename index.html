<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>いろがく推しランキング</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif; max-width: 860px; margin: 24px auto; padding: 0 16px; }
  h1 { font-size: 20px; margin: 0 0 12px; }
  .row { display:flex; gap:8px; align-items:center; flex-wrap: wrap; margin-bottom:10px; }
  textarea { width: 100%; height: 300px; }
  button { padding: 8px 12px; cursor: pointer; }
  .hidden { display:none; }
  .pair { display:grid; grid-template-columns: 1fr 60px 1fr; gap:12px; align-items: stretch; }
  .choice { border:1px solid #ddd; border-radius:12px; padding:16px; text-align:center; cursor:pointer; position:relative; }
  .choice:hover { background:#f7f7f7; }
  .hint { position:absolute; bottom:8px; left:8px; right:8px; font-size:12px; color:#666; }
  .vs { display:flex; align-items:center; justify-content:center; color:#666; }
  ol { padding-left: 22px; }
  .muted { color:#666; font-size:13px; }
  .badge { display:inline-block; background:#eef; color:#334; font-size:12px; padding:2px 6px; border-radius:999px; }
</style>
</head>
<body>
<h1>いろがく推しランキング</h1>

<div class="row">
  <button id="start">開始</button>
  <span class="muted">ボタンを押してね!</span>
</div>

<textarea id="items">兎江戸 和歩
綺城 乙葉
七々瀬 茉緩
温森 あの
雲隠ノ一 楓梅
アイオーン
明智 ひまり
深園 逢夢
佐々木 絢芽
シャーロット・N・モーガン
蓮 鏡世
甘天 心杏
草薙 礼於
倉掛 結凪
小花衣 つづり
西園寺 伊織
坂本 羽音
ニーカ・スミルノワ
空城 みくる
調野 玟那
高木 愛美
高橋 華子
幽刻 ヨネ
結崎 櫻子
凰雅 醒子
金城 あとり
久飴 千歳
久遠 義恒
十羽 ツバサ
榛瀬 百緒
星乃宮 ゆめこ
神子田 夏妃
出雲 澄
大月 周
風端 識
綺城 佳奈
羽宮 ゆい
平野 にあ
美旗 いずな
姚 蘭華
李莉
冷泉 紗麗
御伽 まひる
綺咲 苺香
西院 雅
翠川 恭
那田出 ココ
矢切 あずま
荊棘 密杞
加愛井・ラヴ・舞耶
桐枝 環里
玖重 憩
玖重 ゆる
紗倉 小春
宙波 のんのん
涅采 べに
八木 めいこ
竜染寺 唄芭</textarea>

<div id="ui" class="hidden">
  <p class="muted">比較回数: <span id="cmp">0</span>　
    ♡: <span id="phase" class="badge">候補取り込み</span>　
    候補: <span id="cand">—</span>
  </p>
  <div class="pair">
    <div id="left" class="choice"><div class="hint">← こっちが好き</div></div>
    <div class="vs">VS</div>
    <div id="right" class="choice"><div class="hint">こっちが好き →</div></div>
  </div>
  <div class="row" style="margin-top:10px;">
    <button id="undo">1つもどる</button>
  </div>
</div>

<div id="result" class="hidden">
  <h2>Top <span>10</span> 結果</h2>
  <ol id="list"></ol>
  <div class="row"><button id="restart">もう一度</button></div>
</div>

<script>
(function(){
  function $(id){ return document.getElementById(id); }
  var K = 10, cmpCount = 0, history = [];
  var leftHandler = null, rightHandler = null;

  function setPhase(text){ $("phase").textContent = text; }

  // 共通UI: 左(=a)がより好きなら -1、右(=b)なら +1
  function uiCompare(a,b,label){
    return new Promise(function(resolve){
      $("left").textContent = a; $("right").textContent = b;
      $("cand").textContent = label || "";
      // 旧ハンドラを確実に解除
      if (leftHandler) $("left").removeEventListener("click", leftHandler);
      if (rightHandler) $("right").removeEventListener("click", rightHandler);
      leftHandler = function(){ cleanup(); resolve(-1); };
      rightHandler = function(){ cleanup(); resolve(1); };
      $("left").addEventListener("click", leftHandler);
      $("right").addEventListener("click", rightHandler);
      function cleanup(){
        $("left").removeEventListener("click", leftHandler);
        $("right").removeEventListener("click", rightHandler);
        leftHandler = rightHandler = null;
      }
    }).then(function(res){
      cmpCount++; $("cmp").textContent = String(cmpCount);
      history.push({a:a,b:b,res:res});
      return res;
    });
  }

  // 二分挿入：top内の正しい位置に item を入れる（必ずUI比較を通す）
  async function binaryInsert(top, item){
    if (top.length === 0){ top.push(item); return; }
    let lo = 0, hi = top.length;
    while (lo < hi){
      const mid = Math.floor((lo+hi)/2);
      const r = await uiCompare(item, top[mid], "順位挿入");
      if (r <= 0) hi = mid; else lo = mid + 1;
    }
    top.splice(lo, 0, item);
  }

  // 候補取り込み：Top10に挑戦
  async function challenge(top, item){
    setPhase("候補取り込み");
    if (top.length < K){ await binaryInsert(top, item); return; }
    // まず10位と比較（これで“見ないまま入る”問題を排除）
    let r = await uiCompare(item, top[top.length-1], "まず10位と比較");
    if (r > 0) return; // 負け：入らない
    await binaryInsert(top, item);
    if (top.length > K) top.length = K; // 11位を落とす
  }

  // ★ 1位保証：王者決定戦（Top10内で“最強”を必ず直接比較で決定）
  async function ensureChampion(top){
    setPhase("王者決定戦（1位保証）");
    let champ = top[0];
    for (let i=1;i<top.length;i++){
      const r = await uiCompare(champ, top[i], "1位決定戦");
      if (r > 0) champ = top[i]; // 右が好き＝挑戦者が勝ち
    }
    // champ を先頭に移動
    const idx = top.indexOf(champ);
    if (idx > -1){ top.splice(idx,1); top.unshift(champ); }
  }

  function shuffle(a){
    a = a.slice();
    for (let i=a.length-1;i>0;i--){ const j = (Math.random()*(i+1))|0; [a[i],a[j]]=[a[j],a[i]]; }
    return a;
  }

  $("start").addEventListener("click", async function(){
    const raw = $("items").value.split("\n");
    const list = raw.map(s=>s.trim()).filter(Boolean);
    if (list.length < 2){ alert("2名以上入力してね"); return; }

    cmpCount = 0; history = [];
    $("cmp").textContent = "0"; $("cand").textContent = "—";
    $("result").classList.add("hidden");
    $("ui").classList.remove("hidden");

    const order = shuffle(list);
    const top = [];
    for (let i=0;i<order.length;i++){ await challenge(top, order[i]); }

    // 1位保証フェーズ
    await ensureChampion(top);

    // 結果表示
    const ol = $("list"); ol.innerHTML = "";
    top.forEach(n => { const li = document.createElement("li"); li.textContent = n; ol.appendChild(li); });
    $("ui").classList.add("hidden");
    $("result").classList.remove("hidden");
  });

  $("restart").addEventListener("click", function(){
    $("result").classList.add("hidden");
    cmpCount = 0; history = [];
  });

  $("undo").addEventListener("click", function(){
    if (!history.length) return;
    cmpCount = Math.max(0, cmpCount-1);
    $("cmp").textContent = String(cmpCount);
    history.pop();
    alert("比較カウントだけ1手戻しました（厳密巻き戻しは省略）");
  });
})();
</script>
</body>
</html>
