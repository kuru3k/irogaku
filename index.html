<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<title>いろがく推しランキング</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", system-ui, sans-serif; max-width: 800px; margin: 24px auto; padding: 0 16px; }
  h1 { font-size: 20px; margin: 0 0 12px; }
  .row { display:flex; gap:8px; align-items:center; flex-wrap: wrap; margin-bottom:8px; }
  textarea { width: 100%; height: 300px; }
  button { padding: 8px 12px; }
  .hidden { display:none; }
  .pair { display:flex; gap:12px; align-items:stretch; }
  .choice { flex:1; border:1px solid #ddd; border-radius:10px; padding:16px; text-align:center; cursor:pointer; }
  .choice:hover { background:#f7f7f7; }
  .vs { width:32px; display:flex; align-items:center; justify-content:center; color:#666; }
  ol { padding-left:20px; }
  .muted { color:#666; font-size:13px; }
</style>
</head>
<body>
<h1>いろがく推しランキング</h1>

<div class="row">
  <button id="start">開始</button>
  <span class="muted">ボタンを押してね</span>
</div>

<textarea id="items">兎江戸 和歩
綺城 乙葉
七々瀬 茉緩
温森 あの
雲隠ノ一 楓梅
アイオーン
明智 ひまり
深園 逢夢
佐々木 絢芽
シャーロット・乃亜・モーガン
蓮 鏡世
甘天 心杏
草薙 礼於
倉掛 結凪
小花衣 つづり
西園寺 伊織
坂本 羽音
ニーカ・スミルノワ
空城 みくる
調野 玟那
高木 愛美
高橋 華子
幽刻 ヨネ
結崎 櫻子
凰雅 醒子
金城 あとり
久飴 千歳
久遠 義恒
十羽 ツバサ
榛瀬 百緒
星乃宮 ゆめこ
神子田 夏妃
出雲 澄
大月 周
風端 識
綺城 佳奈
羽宮 ゆい
平野 にあ
美旗 いずな
姚 蘭華
李莉
冷泉 紗麗
御伽 まひる
綺咲 苺香
西院 雅
翠川 恭
那田出 ココ
矢切 あずま
荊棘 密杞
加愛井・ラヴ・舞耶
桐枝 環里
玖重 憩
玖重 ゆる
紗倉 小春
宙波 のんのん
涅采 べに
八木 めいこ
竜染寺 唄芭</textarea>

<div id="ui" class="hidden">
  <p class="muted">比較回数: <span id="cmp">0</span>　候補: <span id="cand">—</span></p>
  <div class="pair">
    <div id="left" class="choice"></div>
    <div class="vs">VS</div>
    <div id="right" class="choice"></div>
  </div>
  <div class="row" style="margin-top:8px;">
    <button id="undo">1手戻す</button>
  </div>
</div>

<div id="result" class="hidden">
  <h2>Top <span>10</span> 結果</h2>
  <ol id="list"></ol>
  <div class="row"><button id="restart">もう一度</button></div>
</div>

<script>
(function(){
  function $(id){ return document.getElementById(id); }

  var K = 10;
  var cmpCount = 0;
  var history = [];

  // UI compare (左が強い=-1 / 右=+1 を返す)
  function uiCompare(a,b,label){
    return new Promise(function(resolve){
      $("left").textContent = a;
      $("right").textContent = b;
      $("cand").textContent = label || "";
      function onL(){ cleanup(); resolve(-1); }
      function onR(){ cleanup(); resolve(1); }
      function cleanup(){
        $("left").removeEventListener("click", onL);
        $("right").removeEventListener("click", onR);
      }
      $("left").addEventListener("click", onL);
      $("right").addEventListener("click", onR);
    }).then(function(res){
      cmpCount++; $("cmp").textContent = String(cmpCount);
      history.push({a:a,b:b,res:res});
      return res;
    });
  }

  // 2分探索で順位に挿入（比較は必ずUI経由）
  function binaryInsert(top, item){
    return new Promise(async function(resolve){
      if (top.length === 0){ top.push(item); return resolve(); }
      var lo = 0, hi = top.length; // [lo, hi)
      while (lo < hi){
        var mid = Math.floor((lo+hi)/2);
        var r = await uiCompare(item, top[mid], "順位挿入");
        if (r <= 0){ hi = mid; } else { lo = mid + 1; }
      }
      top.splice(lo, 0, item);
      resolve();
    });
  }

  // 候補 item をTopKに挑戦させる
  async function challenge(top, item){
    if (top.length < K){
      await binaryInsert(top, item);
      return;
    }
    // まず現在の10位（末尾）と比較
    var r = await uiCompare(item, top[top.length-1], "まずは10位と比較");
    if (r > 0){ // itemの方が弱い
      return;   // 何もしない（Top10残留者は全員、最低1回は登場済み）
    }
    // 強いなら、正しい位置まで二分挿入
    await binaryInsert(top, item);
    // 11位を落とす
    if (top.length > K) top.length = K;
  }

  function shuffle(a){
    a = a.slice();
    for (var i=a.length-1;i>0;i--){
      var j = Math.floor(Math.random()*(i+1));
      var t = a[i]; a[i]=a[j]; a[j]=t;
    }
    return a;
  }

  $("start").addEventListener("click", async function(){
    var raw = $("items").value.split("\n");
    var list = [];
    for (var i=0;i<raw.length;i++){
      var s = raw[i].replace(/^\s+|\s+$/g,"");
      if (s) list.push(s);
    }
    if (list.length < 2){ alert("2名以上入力してね"); return; }

    cmpCount = 0; history = [];
    $("cmp").textContent = "0";
    $("cand").textContent = "—";
    $("result").classList.add("hidden");
    $("ui").classList.remove("hidden");

    var top = [];
    var order = shuffle(list);
    for (var idx=0; idx<order.length; idx++){
      var name = order[idx];
      await challenge(top, name);
    }

    // 結果表示
    var ol = $("list"); ol.innerHTML = "";
    for (var i=0;i<top.length;i++){
      var li = document.createElement("li");
      li.textContent = top[i];
      ol.appendChild(li);
    }
    $("ui").classList.add("hidden");
    $("result").classList.remove("hidden");
  });

  $("restart").addEventListener("click", function(){
    $("result").classList.add("hidden");
    cmpCount = 0; history = [];
  });

  // 直前比較だけ簡易UNDO（順位は再計算しない簡易版）
  $("undo").addEventListener("click", function(){
    if (!history.length) return;
    cmpCount = Math.max(0, cmpCount-1);
    $("cmp").textContent = String(cmpCount);
    history.pop(); // 表示上の比較カウントだけ戻す（厳密巻き戻しは実装簡素化）
    alert("直前の比較カウントを戻しました（厳密な巻き戻しは未対応）");
  });

})();
</script>
</body>
</html>
